<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Skeleton PWA</title>
    <link rel="manifest" href="manifest.webmanifest" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --bg: linear-gradient(145deg, #10131a, #1f1b2f 35%, #162e34 70%, #123438);
        --card-bg: rgba(255, 255, 255, 0.08);
        --card-border: rgba(255, 255, 255, 0.15);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.6);
        --accent: #1db954;
        --accent-dark: #199546;
        --shadow: 0 18px 45px rgba(13, 15, 26, 0.45);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        display: flex;
        align-items: stretch;
        justify-content: center;
        padding: 32px 16px 64px;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: '';
        position: fixed;
        inset: -20% -10%;
        background: radial-gradient(ellipse at top left, rgba(29, 185, 84, 0.32), transparent 60%),
          radial-gradient(ellipse at bottom right, rgba(255, 255, 255, 0.12), transparent 65%);
        filter: blur(0);
        opacity: 0.65;
        transform: rotate(0deg) scale(1);
        animation: aurora 18s ease-in-out infinite alternate;
        pointer-events: none;
        z-index: 0;
      }

      @keyframes aurora {
        from {
          transform: rotate(0deg) scale(1);
          opacity: 0.45;
        }
        50% {
          transform: rotate(8deg) scale(1.1);
          opacity: 0.7;
        }
        to {
          transform: rotate(-6deg) scale(1.05);
          opacity: 0.55;
        }
      }

      main.app {
        width: min(980px, 100%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
        z-index: 1;
      }

      header.top {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: space-between;
        align-items: center;
      }

      header.top h1 {
        margin: 0;
        font-size: clamp(2.4rem, 5vw, 3rem);
        letter-spacing: -0.02em;
      }

      header.top .subtitle {
        margin: 6px 0 0;
        color: rgba(255, 255, 255, 0.78);
        font-weight: 500;
        letter-spacing: 0.08em;
        font-size: 0.9rem;
        display: inline-flex;
        gap: 8px;
        align-items: center;
        position: relative;
        padding-left: 18px;
      }

      header.top .subtitle::before {
        content: '';
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 12px rgba(29, 185, 84, 0.8);
      }

      header.top .subtitle span {
        background: linear-gradient(120deg, #fff, rgba(255, 255, 255, 0.65));
        -webkit-background-clip: text;
        color: transparent;
        background-size: 200% 200%;
        animation: shimmer 6s ease-in-out infinite;
      }

      @keyframes shimmer {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      header.top p:not(.subtitle) {
        margin: 4px 0 0;
        color: var(--muted);
      }

      .auth-block {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .profile {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .profile.hidden { display: none; }

      .profile img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.25);
      }

      .profile-img.hidden { display: none; }

      .profile-name {
        font-weight: 600;
      }

      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      button {
        font: inherit;
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.15);
        color: inherit;
        transition: transform 150ms ease, background 150ms ease, box-shadow 150ms ease;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      button.primary {
        background: var(--accent);
        color: #041407;
        font-weight: 600;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.06), 0 10px 20px rgba(30, 185, 84, 0.35);
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        background: rgba(255, 255, 255, 0.25);
      }

      button.primary:hover:not(:disabled) {
        background: var(--accent-dark);
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.45;
        transform: none;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 24px;
        padding: 24px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(22px);
      }

      .status-card p {
        margin: 0;
        font-size: 1.05rem;
      }

      .player-card {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .now-playing {
        display: grid;
        grid-template-columns: 88px 1fr;
        gap: 18px;
        align-items: center;
      }

      .now-playing img {
        width: 88px;
        height: 88px;
        border-radius: 14px;
        object-fit: cover;
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
      }

      .now-playing img.hidden { display: none; }

      .now-track {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
      }

      .now-artist {
        margin: 6px 0 0;
      }

      .player-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .search-card {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .youtube-card {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .youtube-player-shell {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 24px;
        overflow: hidden;
        background: rgba(6, 7, 14, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      }

      #youtube-player {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
      }

      .youtube-player-shell iframe {
        width: 100%;
        height: 100%;
        border: 0;
      }

      .youtube-placeholder {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        text-align: center;
        padding: 24px;
        color: var(--muted);
        background: rgba(12, 15, 24, 0.55);
        pointer-events: none;
      }

      .youtube-placeholder.hidden {
        display: none;
      }

      .search-form {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px;
      }

      .search-form input {
        border-radius: 999px;
        border: none;
        padding: 12px 18px;
        font: inherit;
        background: rgba(255, 255, 255, 0.12);
        color: inherit;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      }

      .search-form input:disabled {
        opacity: 0.5;
      }

      .results {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 0;
        margin: 0;
        max-height: 360px;
        overflow: auto;
      }

      .results::-webkit-scrollbar {
        width: 8px;
      }

      .results::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 999px;
      }

      .result {
        display: grid;
        grid-template-columns: auto 56px 1fr;
        gap: 14px;
        align-items: center;
        padding: 12px 16px;
        border-radius: 18px;
        background: rgba(6, 7, 14, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: background 150ms ease, transform 150ms ease;
      }

      .result.playing {
        background: rgba(29, 185, 84, 0.18);
        border-color: rgba(29, 185, 84, 0.55);
      }

      .result:hover {
        transform: translateY(-1px);
      }

      .result button.play {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: rgba(29, 185, 84, 0.25);
        border: none;
        display: grid;
        place-items: center;
        color: var(--text);
        font-size: 1.2rem;
      }

      .result button.play:hover:not(:disabled) {
        background: rgba(29, 185, 84, 0.4);
      }

      .result img {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        object-fit: cover;
      }

      .youtube-results .result {
        grid-template-columns: auto 120px 1fr;
        align-items: center;
      }

      .youtube-results .result img {
        width: 120px;
        height: 68px;
        border-radius: 14px;
        object-fit: cover;
      }

      .youtube-results .result button.play {
        background: rgba(255, 255, 255, 0.15);
      }

      .youtube-results .result button.play:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.25);
      }

      .result-noart {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.4rem;
      }

      .result-title {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .search-empty {
        text-align: center;
        padding: 24px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px dashed rgba(255, 255, 255, 0.12);
      }

      @media (max-width: 720px) {
        body { padding: 24px 12px 56px; }
        .now-playing { grid-template-columns: 72px 1fr; }
        .results { max-height: none; }
        .result { grid-template-columns: auto 48px 1fr; }
        .result img,
        .result-noart { width: 48px; height: 48px; }
        .youtube-results .result {
          grid-template-columns: auto 96px 1fr;
        }
        .youtube-results .result img {
          width: 96px;
          height: 60px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        body::before { animation: none; opacity: 0.35; }
        header.top .subtitle span { animation: none; }
      }
    </style>
  </head>
  <body>
    <main class="app">
      <header class="top">
        <div>
          <h1>Skeleton PWA</h1>
          <p class="subtitle"><span>Hi Vivien</span></p>
          <p>Spotify-ready shell</p>
        </div>
        <div class="auth-block">
          <div id="profile" class="profile hidden">
            <img id="profile-img" class="profile-img hidden" alt="" />
            <div>
              <div id="profile-name" class="profile-name"></div>
              <div id="profile-id" class="muted"></div>
            </div>
          </div>
          <button id="login" class="primary">Log in with Spotify</button>
        </div>
      </header>

      <section class="card status-card">
        <p id="status">Deployed? Next step is Spotify auth.</p>
      </section>

      <section class="card player-card">
        <div class="player-header">
          <h2>Now Playing</h2>
          <div class="player-controls">
            <button id="play" disabled>Play</button>
            <button id="pause" disabled>Pause</button>
          </div>
        </div>
        <div class="now-playing">
          <img id="now-art" class="hidden" alt="Album art" />
          <div>
            <p id="now-track" class="now-track">Nothing playing yet.</p>
            <p id="now-artist" class="muted now-artist">Use the search below to start playback.</p>
          </div>
        </div>
      </section>

      <section class="card search-card">
        <div>
          <h2>Search tracks</h2>
          <p class="muted">Look up songs, tap play, and control playback right in the browser.</p>
        </div>
        <form id="search-form" class="search-form">
          <input id="search" type="search" placeholder="Search for songs…" autocomplete="off" />
          <button type="submit">Search</button>
        </form>
        <ul id="results" class="results">
          <li class="search-empty">Log in first to search the Spotify catalog.</li>
        </ul>
      </section>

      <section class="card youtube-card">
        <div>
          <h2>YouTube player</h2>
          <p class="muted">Search YouTube and play videos inline with the embedded player.</p>
        </div>
        <div class="youtube-player-shell">
          <div id="youtube-player"></div>
          <div id="youtube-placeholder" class="youtube-placeholder">
            Search for a video below to load it here.
          </div>
        </div>
        <form id="yt-search-form" class="search-form">
          <input id="yt-search" type="search" placeholder="Search YouTube videos…" autocomplete="off" />
          <button type="submit">Search YouTube</button>
        </form>
        <ul id="yt-results" class="results youtube-results">
          <li class="search-empty">Try searching for any music video or clip.</li>
        </ul>
      </section>
    </main>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="module">
      import { ensureAuth, getAccessTokenSync } from './auth.js';
      import { initPlayer, startPlayback, pause, resume, transferPlayback } from './player.js';

      const status = document.getElementById('status');
      const loginBtn = document.getElementById('login');
      const profile = document.getElementById('profile');
      const profileImg = document.getElementById('profile-img');
      const profileName = document.getElementById('profile-name');
      const profileId = document.getElementById('profile-id');
      const playBtn = document.getElementById('play');
      const pauseBtn = document.getElementById('pause');
      const nowTrack = document.getElementById('now-track');
      const nowArtist = document.getElementById('now-artist');
      const nowArt = document.getElementById('now-art');
      const searchForm = document.getElementById('search-form');
      const searchInput = document.getElementById('search');
      const searchButton = searchForm.querySelector('button');
      const results = document.getElementById('results');
      const ytSearchForm = document.getElementById('yt-search-form');
      const ytSearchInput = document.getElementById('yt-search');
      const ytResults = document.getElementById('yt-results');
      const youtubePlaceholder = document.getElementById('youtube-placeholder');

      let ytApiKeyCache = null;
      let ytApiKeyPromise = null;

      async function getYouTubeApiKey() {
        if (ytApiKeyCache) return ytApiKeyCache;
        if (!ytApiKeyPromise) {
          ytApiKeyPromise = fetch('/api/youtube-key', { cache: 'no-store' })
            .then((res) => {
              if (!res.ok) {
                throw new Error(`YouTube API key unavailable (${res.status})`);
              }
              return res.json();
            })
            .then((json) => {
              if (!json || typeof json.key !== 'string' || !json.key) {
                throw new Error('YouTube API key missing from response');
              }
              ytApiKeyCache = json.key;
              return ytApiKeyCache;
            })
            .catch((err) => {
              ytApiKeyPromise = null;
              throw err;
            });
        }
        return ytApiKeyPromise;
      }

      const state = {
        sdkReady: false,
        player: null,
        deviceId: null,
        activeUri: null
      };

      const SAMPLE_URI = 'spotify:track:3n3Ppam7vgaVa1iaRUc9Lp';

      const youtubeState = {
        player: null,
        ready: false,
        pendingVideoId: null,
        currentVideoId: null
      };

      function setSearchEnabled(enabled) {
        searchInput.disabled = !enabled;
        searchButton.disabled = !enabled;
        if (!enabled) {
          results.innerHTML = '<li class="search-empty">Log in first to search the Spotify catalog.</li>';
        } else if (
          !results.children.length ||
          results.firstElementChild?.classList.contains('search-empty')
        ) {
          results.innerHTML = '<li class="search-empty">Search for your favorite songs.</li>';
        }
      }

      function setProfileHidden(hidden) {
        profile.classList.toggle('hidden', hidden);
      }

      function updateStatus(message) {
        status.textContent = message;
      }

      function renderProfile(me) {
        if (!me) {
          setProfileHidden(true);
          profileName.textContent = '';
          profileId.textContent = '';
          profileImg.src = '';
          profileImg.classList.add('hidden');
          return;
        }
        setProfileHidden(false);
        const name = me.display_name || me.id;
        profileName.textContent = name;
        profileId.textContent = me.product ? `${me.product.toUpperCase()} • ${me.id}` : me.id;
        if (me.images && me.images.length) {
          profileImg.src = me.images[0].url;
          profileImg.classList.remove('hidden');
        } else {
          profileImg.src = '';
          profileImg.classList.add('hidden');
        }
      }

      function renderNowPlaying(track, paused) {
        if (!track) {
          nowTrack.textContent = 'Nothing playing yet.';
          nowArtist.textContent = 'Use the search below to start playback.';
          nowArt.classList.add('hidden');
          nowArt.removeAttribute('src');
          state.activeUri = null;
          highlightActiveResult(null);
          return;
        }
        nowTrack.textContent = track.name;
        nowArtist.textContent = `${track.artists.map(a => a.name).join(', ')}${paused ? ' • Paused' : ''}`;
        const image = track.album.images?.find((img) => img.height <= 320) || track.album.images?.[0];
        if (image) {
          nowArt.src = image.url;
          nowArt.classList.remove('hidden');
        } else {
          nowArt.removeAttribute('src');
          nowArt.classList.add('hidden');
        }
        state.activeUri = track.uri;
        highlightActiveResult(track.uri);
      }

      function highlightActiveResult(uri) {
        Array.from(results.querySelectorAll('.result')).forEach((item) => {
          item.classList.toggle('playing', uri && item.dataset.uri === uri);
        });
      }

      function highlightYouTubeResult(videoId) {
        Array.from(ytResults.querySelectorAll('.result')).forEach((item) => {
          item.classList.toggle('playing', Boolean(videoId) && item.dataset.videoId === videoId);
        });
      }

      function ensureYouTubePlayer() {
        if (youtubeState.player) {
          return youtubeState.player;
        }
        if (window.YT && typeof window.YT.Player === 'function') {
          youtubeState.ready = false;
          const config = {
            playerVars: { rel: 0, modestbranding: 1, playsinline: 1 },
            events: {
              onReady: () => {
                youtubeState.ready = true;
                if (youtubeState.pendingVideoId) {
                  youtubeState.player.loadVideoById(youtubeState.pendingVideoId);
                  youtubeState.pendingVideoId = null;
                  youtubePlaceholder.classList.add('hidden');
                  try {
                    youtubeState.player.playVideo();
                  } catch (err) {
                    console.warn('Unable to autoplay YouTube video on ready', err);
                  }
                }
              },
              onStateChange: (event) => {
                if (window.YT && event.data === window.YT.PlayerState.PLAYING) {
                  youtubePlaceholder.classList.add('hidden');
                }
              }
            }
          };
          if (youtubeState.pendingVideoId) {
            config.videoId = youtubeState.pendingVideoId;
          }
          youtubeState.player = new window.YT.Player('youtube-player', config);
        }
        return youtubeState.player;
      }

      function playYouTubeVideo(videoId) {
        if (!videoId) return;
        youtubeState.currentVideoId = videoId;
        highlightYouTubeResult(videoId);
        youtubeState.pendingVideoId = videoId;
        const player = ensureYouTubePlayer();
        if (youtubeState.ready && player) {
          player.loadVideoById(videoId);
          youtubeState.pendingVideoId = null;
          youtubePlaceholder.classList.add('hidden');
          try {
            player.playVideo();
          } catch (err) {
            console.warn('Unable to autoplay YouTube video', err);
          }
        }
      }

      async function handleYouTubeSearch(event) {
        event.preventDefault();
        const query = ytSearchInput.value.trim();
        if (!query) return;
        ytResults.innerHTML = '<li class="search-empty">Searching YouTube…</li>';
        try {
          const apiKey = await getYouTubeApiKey();
          const url = new URL('https://www.googleapis.com/youtube/v3/search');
          url.search = new URLSearchParams({
            part: 'snippet',
            type: 'video',
            maxResults: '10',
            q: query,
            key: apiKey,
            videoEmbeddable: 'true'
          }).toString();
          const res = await fetch(url.toString());
          if (!res.ok) throw new Error(`YouTube search failed: ${res.status}`);
          const data = await res.json();
          const items = data.items ?? [];
          const frag = document.createDocumentFragment();
          let appended = 0;
          items.forEach((item) => {
            const videoId = item.id?.videoId;
            if (!videoId) return;
            const li = document.createElement('li');
            li.className = 'result';
            li.dataset.videoId = videoId;

            const playButton = document.createElement('button');
            playButton.className = 'play';
            playButton.type = 'button';
            playButton.dataset.videoId = videoId;
            const titleText = item.snippet?.title || 'YouTube video';
            playButton.setAttribute('aria-label', `Play ${titleText}`);
            playButton.textContent = '▶';

            const thumb =
              item.snippet?.thumbnails?.medium ||
              item.snippet?.thumbnails?.high ||
              item.snippet?.thumbnails?.default;
            let art;
            if (thumb?.url) {
              art = document.createElement('img');
              art.src = thumb.url;
              art.alt = '';
            } else {
              art = document.createElement('div');
              art.className = 'result-noart';
              art.setAttribute('aria-hidden', 'true');
              art.textContent = '▶';
            }

            const info = document.createElement('div');
            const title = document.createElement('div');
            title.className = 'result-title';
            title.textContent = titleText;
            const meta = document.createElement('div');
            meta.className = 'muted';
            const channel = item.snippet?.channelTitle || 'Unknown channel';
            let published = 'Unknown date';
            if (item.snippet?.publishedAt) {
              const d = new Date(item.snippet.publishedAt);
              if (!Number.isNaN(d.valueOf())) {
                published = d.toLocaleDateString();
              }
            }
            meta.textContent = `${channel} • ${published}`;

            info.appendChild(title);
            info.appendChild(meta);

            li.appendChild(playButton);
            li.appendChild(art);
            li.appendChild(info);
            frag.appendChild(li);
            appended += 1;
          });

          if (!appended) {
            ytResults.innerHTML = '<li class="search-empty">No embeddable videos matched your search.</li>';
            return;
          }

          ytResults.innerHTML = '';
          ytResults.appendChild(frag);
          highlightYouTubeResult(youtubeState.currentVideoId);
        } catch (err) {
          console.error('YouTube search failed', err);
          if (err?.message?.includes('YouTube API key')) {
            ytResults.innerHTML =
              '<li class="search-empty">YouTube API key not configured. Add it as the YOUTUBE_API_KEY environment variable.</li>';
          } else {
            ytResults.innerHTML = '<li class="search-empty">Unable to load YouTube results right now.</li>';
          }
        }
      }

      async function fetchProfile() {
        const token = getAccessTokenSync();
        if (!token) {
          renderProfile(null);
          return;
        }
        try {
          const res = await fetch('https://api.spotify.com/v1/me', {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Profile fetch failed');
          const me = await res.json();
          renderProfile(me);
          updateStatus(`Signed in as ${me.display_name || me.id}.`);
        } catch (err) {
          renderProfile(null);
          updateStatus('Signed in, but unable to load profile details.');
          console.warn(err);
        }
      }

      async function ensurePlayer() {
        const token = getAccessTokenSync();
        if (!token) {
          updateStatus('Log in to initialize the Spotify player.');
          setSearchEnabled(false);
          return;
        }
        if (!state.sdkReady) {
          updateStatus('Signed in. Waiting for the Spotify Web Playback SDK…');
          return;
        }
        if (state.player) return;

        try {
          updateStatus('Initializing Spotify player…');
          const { deviceId, player } = await initPlayer(() => getAccessTokenSync(), {
            onStateChange: (playerState) => {
              const track = playerState?.track_window?.current_track;
              const paused = playerState?.paused ?? true;
              renderNowPlaying(track, paused);
            },
            onNotReady: ({ device_id }) => {
              if (state.deviceId === device_id) {
                updateStatus('Spotify marked this device as offline. Press play to reconnect.');
              }
            }
          });
          state.deviceId = deviceId;
          state.player = player;
          playBtn.disabled = false;
          pauseBtn.disabled = false;
          setSearchEnabled(true);
          updateStatus(`Device ready • ${deviceId}`);
          try {
            await transferPlayback(deviceId);
          } catch (err) {
            console.warn('Transfer playback failed', err);
          }
        } catch (err) {
          console.error(err);
          updateStatus('Failed to initialize the Spotify player. See console for details.');
        }
      }

      async function handleSearch(event) {
        event.preventDefault();
        const query = searchInput.value.trim();
        if (!query) return;
        const token = getAccessTokenSync();
        if (!token) {
          updateStatus('Log in with Spotify to search the catalog.');
          return;
        }
        results.innerHTML = '<li class="search-empty">Searching…</li>';
        try {
          const url = new URL('https://api.spotify.com/v1/search');
          url.search = new URLSearchParams({ q: query, type: 'track', limit: '10' }).toString();
          const res = await fetch(url.toString(), {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (!res.ok) throw new Error('Search failed');
          const data = await res.json();
          const tracks = data.tracks?.items ?? [];
          if (!tracks.length) {
            results.innerHTML = '<li class="search-empty">No tracks matched. Try another search.</li>';
            return;
          }
          const frag = document.createDocumentFragment();
          tracks.forEach((track) => {
            const li = document.createElement('li');
            li.className = 'result';
            li.dataset.uri = track.uri;
            const image = track.album.images?.[2] || track.album.images?.[1] || track.album.images?.[0];
            const artwork = image
              ? `<img src="${image.url}" alt="" />`
              : '<div class="result-noart" aria-hidden="true">♪</div>';
            li.innerHTML = `
              <button class="play" type="button" data-uri="${track.uri}" aria-label="Play ${track.name}">▶</button>
              ${artwork}
              <div>
                <div class="result-title">${track.name}</div>
                <div class="muted">${track.artists.map((a) => a.name).join(', ')} • ${track.album.name}</div>
              </div>
            `;
            frag.appendChild(li);
          });
          results.innerHTML = '';
          results.appendChild(frag);
          highlightActiveResult(state.activeUri);
        } catch (err) {
          console.error(err);
          results.innerHTML = '<li class="search-empty">Something went wrong. Check the console for details.</li>';
        }
      }

      async function playUri(uri) {
        if (!state.deviceId) {
          updateStatus('Player is not ready yet.');
          await ensurePlayer();
          if (!state.deviceId) return;
        }
        try {
          updateStatus('Starting playback…');
          await startPlayback(state.deviceId, { uris: [uri] });
          if (state.player) {
            await resume(state.player);
          }
        } catch (err) {
          console.error(err);
          updateStatus('Unable to start playback. Check the console for details.');
        }
      }

      loginBtn.addEventListener('click', async () => {
        updateStatus('Checking Spotify authentication…');
        const token = await ensureAuth();
        if (token) {
          setSearchEnabled(true);
          await fetchProfile();
          await ensurePlayer();
        }
      });

      playBtn.addEventListener('click', async () => {
        if (!state.deviceId) {
          await ensurePlayer();
          if (!state.deviceId) {
            return;
          }
        }
        await playUri(SAMPLE_URI);
      });

      pauseBtn.addEventListener('click', () => {
        if (state.player) {
          pause(state.player);
        }
      });

      searchForm.addEventListener('submit', handleSearch);

      results.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-uri]');
        if (!button) return;
        const uri = button.dataset.uri;
        playUri(uri);
      });

      ytSearchForm.addEventListener('submit', handleYouTubeSearch);

      ytResults.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-video-id]');
        if (!button) return;
        playYouTubeVideo(button.dataset.videoId);
      });

      window.onYouTubeIframeAPIReady = () => {
        ensureYouTubePlayer();
      };

      window.onSpotifyWebPlaybackSDKReady = async () => {
        state.sdkReady = true;
        await ensurePlayer();
      };

      const existingToken = getAccessTokenSync();
      if (existingToken) {
        setSearchEnabled(true);
        fetchProfile();
        ensurePlayer();
      } else {
        setSearchEnabled(false);
        setProfileHidden(true);
      }
    </script>
  </body>
</html>
