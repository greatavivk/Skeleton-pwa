<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Skeleton PWA Media Hub</title>
    <link rel="manifest" href="manifest.webmanifest" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f5f6fb;
        --text: #111827;
        --muted: #5f6b7b;
        --card-bg: rgba(255, 255, 255, 0.92);
        --card-border: rgba(17, 24, 39, 0.08);
        --surface: rgba(255, 255, 255, 0.7);
        --accent: #2563eb;
        --accent-contrast: #ffffff;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background-color: var(--bg);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0f172a;
          --text: #f8fafc;
          --muted: #cbd5f5;
          --card-bg: rgba(15, 23, 42, 0.85);
          --card-border: rgba(148, 163, 184, 0.2);
          --surface: rgba(30, 41, 59, 0.7);
          --accent: #60a5fa;
          --accent-contrast: #0f172a;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, rgba(99, 102, 241, 0.18), transparent 55%),
          var(--bg);
        color: var(--text);
      }

      main {
        max-width: 1000px;
        margin: 0 auto;
        padding: 3rem 1.5rem 4rem;
        display: grid;
        gap: 2rem;
      }

      header.hero {
        display: grid;
        gap: 0.75rem;
        text-align: center;
      }

      header.hero h1 {
        font-size: clamp(2.25rem, 4vw, 3rem);
        margin: 0;
      }

      header.hero p {
        margin: 0 auto;
        max-width: 42ch;
        color: var(--muted);
        font-size: 1.05rem;
      }

      section.card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        padding: clamp(1.5rem, 3vw, 2.25rem);
        box-shadow: 0 20px 55px rgba(15, 23, 42, 0.14);
        display: grid;
        gap: 1.25rem;
      }

      section.card h2 {
        margin: 0;
        font-size: 1.4rem;
      }

      .muted {
        color: var(--muted);
        margin: 0;
      }

      .small {
        font-size: 0.85rem;
      }

      .counter-display {
        display: inline-grid;
        grid-template-columns: repeat(3, minmax(3rem, 1fr));
        align-items: center;
        justify-items: center;
        gap: 0.75rem;
        align-self: center;
      }

      .counter-display button {
        width: 3.25rem;
        height: 3.25rem;
        border-radius: 999px;
        font-size: 1.75rem;
        font-weight: 600;
      }

      output#counter-value {
        font-size: clamp(2.5rem, 8vw, 3.5rem);
        font-variant-numeric: tabular-nums;
        font-weight: 700;
        min-width: 5rem;
        text-align: center;
      }

      .counter-actions {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
      }

      .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      button,
      input,
      textarea {
        font: inherit;
      }

      button {
        border-radius: 999px;
        border: 1px solid transparent;
        padding: 0.65rem 1.4rem;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent);
        color: var(--accent-contrast);
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.2);
      }

      button:hover:not(:disabled) {
        transform: translateY(-1px);
        filter: brightness(1.05);
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        filter: saturate(0.5);
      }

      button.secondary {
        background: transparent;
        color: var(--text);
        border-color: var(--card-border);
        box-shadow: none;
      }

      button.secondary:hover:not(:disabled) {
        border-color: var(--accent);
        color: var(--accent);
      }

      label.field {
        display: grid;
        gap: 0.35rem;
      }

      label.field span {
        font-weight: 600;
      }

      input[type='text'],
      input[type='password'] {
        border-radius: 12px;
        border: 1px solid var(--card-border);
        padding: 0.75rem 1rem;
        background: var(--surface);
        color: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input[type='text']:focus,
      input[type='password']:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25);
      }

      #now {
        min-height: 1.25rem;
        font-weight: 500;
      }

      .spotify-status[data-tone='error'] {
        color: #dc2626;
      }

      .spotify-status[data-tone='success'] {
        color: #15803d;
      }

      .youtube-results {
        display: grid;
        gap: 1.25rem;
      }

      .yt-card {
        display: grid;
        grid-template-columns: minmax(180px, 240px) 1fr;
        gap: 1rem;
        background: var(--surface);
        border-radius: 16px;
        padding: 1rem;
        border: 1px solid var(--card-border);
      }

      .yt-card img {
        width: 100%;
        border-radius: 12px;
        display: block;
      }

      .yt-meta {
        display: grid;
        gap: 0.35rem;
        align-content: start;
      }

      .yt-meta a {
        color: inherit;
        font-weight: 600;
        text-decoration: none;
      }

      .yt-meta a:hover {
        text-decoration: underline;
        color: var(--accent);
      }

      .yt-channel {
        font-size: 0.95rem;
        color: var(--muted);
      }

      .yt-date {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }

      .yt-description {
        font-size: 0.95rem;
        color: var(--text);
        opacity: 0.9;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      @media (max-width: 900px) {
        .yt-card {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 600px) {
        .button-row {
          flex-direction: column;
          align-items: stretch;
        }

        button,
        .counter-display button {
          width: 100%;
        }

        .counter-display {
          grid-template-columns: repeat(3, minmax(2.75rem, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="hero">
        <h1>Skeleton PWA Media Hub</h1>
        <p>
          A single offline-friendly surface that keeps your counter tidy, wires up Spotify’s
          Web Playback SDK, and performs quick YouTube Data API searches.
        </p>
      </header>

      <section class="card" id="counter-card">
        <h2>Session counter</h2>
        <p class="muted">Keep a running tally that survives refreshes and works offline.</p>
        <div class="counter-display" role="group" aria-label="Counter controls">
          <button id="counter-decrement" type="button" aria-label="Decrease counter">−</button>
          <output id="counter-value" role="status" aria-live="polite">0</output>
          <button id="counter-increment" type="button" aria-label="Increase counter">+</button>
        </div>
        <div class="counter-actions">
          <button id="counter-reset" type="button" class="secondary">Reset</button>
        </div>
      </section>

      <section class="card" id="spotify-card">
        <h2>Spotify playback</h2>
        <p class="muted spotify-status" id="spotify-status">Waiting for Spotify SDK…</p>
        <div class="button-row">
          <button id="login" type="button">Log in with Spotify</button>
          <button id="play" type="button" disabled>Play sample</button>
          <button id="pause" type="button" disabled class="secondary">Pause</button>
        </div>
        <div id="now" aria-live="polite" aria-atomic="true">Nothing playing yet.</div>
        <p class="muted small">Requires Spotify Premium. Sample track: Daft Punk – Harder, Better, Faster, Stronger.</p>
      </section>

      <section class="card" id="youtube-card">
        <h2>YouTube quick search</h2>
        <form id="youtube-form" autocomplete="off" novalidate>
          <label class="field" for="youtube-query">
            <span>Search term</span>
            <input id="youtube-query" name="query" type="text" placeholder="e.g. lo-fi beats" required />
          </label>
          <label class="field" for="youtube-key">
            <span>YouTube Data API key</span>
            <input
              id="youtube-key"
              name="key"
              type="password"
              placeholder="Paste your key"
              required
              autocomplete="off"
            />
          </label>
          <div class="button-row">
            <button type="submit">Search YouTube</button>
            <button type="button" id="youtube-clear" class="secondary">Clear results</button>
          </div>
        </form>
        <p class="muted" id="youtube-status">Enter a YouTube Data API key to search.</p>
        <div id="youtube-results" class="youtube-results" aria-live="polite"></div>
      </section>
    </main>

    <!-- Spotify Web Playback SDK -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>

    <script type="module">
      import { ensureAuth, getAccessTokenSync } from './auth.js';
      import { initPlayer, startPlayback, pause } from './player.js';

      // Counter setup
      const counterValueEl = document.getElementById('counter-value');
      const counterIncBtn = document.getElementById('counter-increment');
      const counterDecBtn = document.getElementById('counter-decrement');
      const counterResetBtn = document.getElementById('counter-reset');
      const COUNTER_STORAGE_KEY = 'pwa_counter';

      let counter = Number(localStorage.getItem(COUNTER_STORAGE_KEY) || '0');
      if (!Number.isFinite(counter)) counter = 0;

      function renderCounter(value) {
        counterValueEl.textContent = value;
        counterValueEl.dataset.value = value;
      }

      function updateCounter(next) {
        counter = next;
        renderCounter(counter);
        localStorage.setItem(COUNTER_STORAGE_KEY, String(counter));
      }

      renderCounter(counter);
      counterIncBtn.addEventListener('click', () => updateCounter(counter + 1));
      counterDecBtn.addEventListener('click', () => updateCounter(counter - 1));
      counterResetBtn.addEventListener('click', () => updateCounter(0));

      // Spotify setup
      const spotifyStatus = document.getElementById('spotify-status');
      const loginBtn = document.getElementById('login');
      const playBtn = document.getElementById('play');
      const pauseBtn = document.getElementById('pause');
      const nowPlayingEl = document.getElementById('now');

      let spotifyPlayer = null;
      let spotifyDeviceId = null;

      function setSpotifyStatus(message, tone = 'info') {
        spotifyStatus.textContent = message;
        spotifyStatus.dataset.tone = tone;
      }

      function formatTrack(state) {
        if (!state || !state.track_window || !state.track_window.current_track) {
          return 'Nothing playing yet.';
        }
        const { current_track: track } = state.track_window;
        const artists = (track.artists || []).map(artist => artist.name).join(', ');
        return artists ? `${track.name} — ${artists}` : track.name;
      }

      const getToken = async () => {
        let token = getAccessTokenSync();
        if (token) return token;
        await ensureAuth({ interactive: false });
        token = getAccessTokenSync();
        return token;
      };

      async function prepareSpotifyPlayer() {
        try {
          const token = await getToken();
          if (!token) {
            setSpotifyStatus('Log in with Spotify to enable playback.');
            playBtn.disabled = true;
            pauseBtn.disabled = true;
            return;
          }
        } catch (err) {
          console.error(err);
          setSpotifyStatus(err.message || 'Spotify authorization failed.', 'error');
          return;
        }

        if (!window.Spotify || !window.Spotify.Player) {
          setSpotifyStatus('Waiting for Spotify SDK…');
          return;
        }

        if (spotifyPlayer) {
          setSpotifyStatus(`Device ready: ${spotifyDeviceId}`, 'success');
          return;
        }

        setSpotifyStatus('Initializing Spotify player…');
        try {
          const { deviceId, player } = await initPlayer(getToken);
          spotifyPlayer = player;
          spotifyDeviceId = deviceId;
          setSpotifyStatus(`Device ready: ${deviceId}`, 'success');
          playBtn.disabled = false;
          pauseBtn.disabled = false;

          player.addListener('player_state_changed', state => {
            nowPlayingEl.textContent = formatTrack(state);
          });

          player.addListener('initialization_error', ({ message }) => {
            setSpotifyStatus(`Spotify init error: ${message}`, 'error');
          });
          player.addListener('authentication_error', ({ message }) => {
            setSpotifyStatus(`Spotify auth error: ${message}`, 'error');
          });
          player.addListener('account_error', ({ message }) => {
            setSpotifyStatus(`Spotify account error: ${message}`, 'error');
          });
          player.addListener('playback_error', ({ message }) => {
            setSpotifyStatus(`Spotify playback error: ${message}`, 'error');
          });
          player.addListener('not_ready', ({ device_id }) => {
            if (device_id === spotifyDeviceId) {
              setSpotifyStatus('Spotify device went offline. Reload to reconnect.', 'error');
              playBtn.disabled = true;
              pauseBtn.disabled = true;
            }
          });

          playBtn.onclick = async () => {
            playBtn.disabled = true;
            try {
              setSpotifyStatus('Attempting to play the sample track…');
              await startPlayback(deviceId, { uris: ['spotify:track:3n3Ppam7vgaVa1iaRUc9Lp'] }, getToken);
              setSpotifyStatus('Sample track sent to the Spotify player.', 'success');
            } catch (err) {
              console.error(err);
              setSpotifyStatus(err.message || 'Playback failed.', 'error');
            } finally {
              playBtn.disabled = false;
            }
          };

          pauseBtn.onclick = async () => {
            pauseBtn.disabled = true;
            try {
              await pause(player);
              setSpotifyStatus('Playback paused.');
            } catch (err) {
              setSpotifyStatus(err.message || 'Unable to pause playback.', 'error');
            } finally {
              pauseBtn.disabled = false;
            }
          };
        } catch (err) {
          console.error(err);
          setSpotifyStatus(err.message || 'Failed to initialise Spotify player.', 'error');
        }
      }

      loginBtn.addEventListener('click', async () => {
        loginBtn.disabled = true;
        try {
          setSpotifyStatus('Opening Spotify login…');
          const token = await ensureAuth();
          if (token) {
            await prepareSpotifyPlayer();
          }
        } catch (err) {
          console.error(err);
          setSpotifyStatus(err.message || 'Spotify login failed.', 'error');
        } finally {
          loginBtn.disabled = false;
        }
      });

      window.onSpotifyWebPlaybackSDKReady = () => {
        prepareSpotifyPlayer();
      };

      (async () => {
        try {
          await ensureAuth({ interactive: false });
        } catch (err) {
          console.error(err);
          setSpotifyStatus(err.message || 'Spotify auth error.', 'error');
        }
        await prepareSpotifyPlayer();
      })();

      // YouTube Data API helper
      const ytForm = document.getElementById('youtube-form');
      const ytQueryInput = document.getElementById('youtube-query');
      const ytKeyInput = document.getElementById('youtube-key');
      const ytClearBtn = document.getElementById('youtube-clear');
      const ytStatus = document.getElementById('youtube-status');
      const ytResults = document.getElementById('youtube-results');
      const YT_KEY_STORAGE = 'yt_api_key';

      const savedKey = localStorage.getItem(YT_KEY_STORAGE);
      if (savedKey) {
        ytKeyInput.value = savedKey;
        ytStatus.textContent = 'API key stored locally for this browser.';
      }

      ytKeyInput.addEventListener('change', () => {
        const value = ytKeyInput.value.trim();
        if (value) {
          localStorage.setItem(YT_KEY_STORAGE, value);
          ytStatus.textContent = 'API key saved locally. Ready to search!';
        } else {
          localStorage.removeItem(YT_KEY_STORAGE);
          ytStatus.textContent = 'Enter a YouTube Data API key to search.';
        }
      });

      ytClearBtn.addEventListener('click', () => {
        ytResults.innerHTML = '';
        ytQueryInput.value = '';
        ytStatus.textContent = ytKeyInput.value.trim()
          ? 'Cleared results. Enter a search term to try again.'
          : 'Enter a YouTube Data API key to search.';
      });

      ytForm.addEventListener('submit', async event => {
        event.preventDefault();
        const query = ytQueryInput.value.trim();
        const key = ytKeyInput.value.trim();

        if (!key) {
          ytStatus.textContent = 'Paste your YouTube Data API key first.';
          ytKeyInput.focus();
          return;
        }

        localStorage.setItem(YT_KEY_STORAGE, key);

        if (!query) {
          ytStatus.textContent = 'Type something to search for.';
          ytQueryInput.focus();
          return;
        }

        ytStatus.textContent = 'Searching YouTube…';
        ytResults.innerHTML = '';

        try {
          const params = new URLSearchParams({
            key,
            q: query,
            part: 'snippet',
            type: 'video',
            maxResults: '6'
          });
          const res = await fetch(`https://www.googleapis.com/youtube/v3/search?${params.toString()}`);
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || `YouTube API error (${res.status})`);
          }
          const json = await res.json();
          const items = (json.items || []).filter(item => item.id && item.id.videoId);
          if (!items.length) {
            ytStatus.textContent = 'No videos found for that search.';
            return;
          }
          ytStatus.textContent = `Showing ${items.length} result${items.length === 1 ? '' : 's'}.`;
          renderYoutubeResults(items);
        } catch (err) {
          console.error(err);
          ytStatus.textContent = err.message || 'Unexpected YouTube API error.';
        }
      });

      function renderYoutubeResults(items) {
        ytResults.innerHTML = '';
        for (const item of items) {
          const videoId = item.id.videoId;
          const snippet = item.snippet || {};
          const title = snippet.title || 'Untitled video';
          const channelTitle = snippet.channelTitle || 'Unknown channel';
          const description = snippet.description || '';
          const thumb = (snippet.thumbnails && (snippet.thumbnails.medium || snippet.thumbnails.high || snippet.thumbnails.default)) || null;

          const card = document.createElement('article');
          card.className = 'yt-card';

          const thumbLink = document.createElement('a');
          thumbLink.href = `https://www.youtube.com/watch?v=${videoId}`;
          thumbLink.target = '_blank';
          thumbLink.rel = 'noopener noreferrer';

          const img = document.createElement('img');
          img.alt = `Thumbnail for ${title}`;
          img.loading = 'lazy';
          if (thumb) {
            img.src = thumb.url;
            if (thumb.width) img.width = thumb.width;
            if (thumb.height) img.height = thumb.height;
          } else {
            img.src = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
          }
          thumbLink.appendChild(img);

          const meta = document.createElement('div');
          meta.className = 'yt-meta';

          const titleLink = document.createElement('a');
          titleLink.href = thumbLink.href;
          titleLink.target = '_blank';
          titleLink.rel = 'noopener noreferrer';
          titleLink.textContent = title;

          const channelEl = document.createElement('p');
          channelEl.className = 'yt-channel';
          channelEl.textContent = channelTitle;

          const dateEl = document.createElement('p');
          dateEl.className = 'yt-date';
          if (snippet.publishedAt) {
            const date = new Date(snippet.publishedAt);
            if (!Number.isNaN(date.getTime())) {
              dateEl.textContent = date.toLocaleDateString();
            }
          }

          const descriptionEl = document.createElement('p');
          descriptionEl.className = 'yt-description';
          descriptionEl.textContent = description;

          meta.append(titleLink, channelEl);
          if (dateEl.textContent) meta.appendChild(dateEl);
          if (descriptionEl.textContent) meta.appendChild(descriptionEl);

          card.append(thumbLink, meta);
          ytResults.appendChild(card);
        }
      }
    </script>
  </body>
</html>
